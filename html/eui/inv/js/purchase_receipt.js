dwap.page.trace_onChange=function(e,t){e=parseInt(e);var i,a=$(this),d=$("#receiptlines"),n=(d.datagrid("getSelected").WOREF,$("#tracedg")),r=n.datagrid("getSelected"),o=(n.datagrid("getRowIndex",r),d.datagrid("getSelected").QTY_BAL,d.datagrid("getSelected").QTY_BAL),l=0;n.datagrid("getRows").map(function(t){t.TRACE_ID&&t.TRACE_ID!=r.TRACE_ID?l+=parseFloat(t.QTY):l+=parseFloat(e)}),l>o&&(i=`Quantity ${l} exceeds required ${o}`,setTimeout(function(){i&&msgbox(i),a.numberspinner("setValue",t)}))},dwap.page.notrace_onChange=function(e,t){var i=$(this);e>$("#receiptlines").datagrid("getSelected").QTY_BAL&&setTimeout(function(){i.numberspinner("setValue",t)})},dwap.page.traceclk=function(){function e(){var e=$("div#traced"),a=t.datagrid("getSelected")._DIM_TRACKED,d=!1;d="N"!=t.datagrid("getSelected").TRACEABLE,i.datagrid("getColumnOption","TRACE_ID").editor.options.required=d,i.datagrid("getColumnOption","TRACE_ID").editor.options.readonly=!d;var n=!1,r=["L","W","H"];switch(a){case"Y":r.map(e=>{var a="_"+e;n="Y"!=t.datagrid("getSelected")[a],i.datagrid("getColumnOption",e).editor.options.readonly=n,i.datagrid("getColumnOption",e).editor.options.required=!n});break;case"N":default:n=!0,r.map(e=>{i.datagrid("getColumnOption",e).editor.options.readonly=n,i.datagrid("getColumnOption",e).editor.options.required=!n})}var o=t.datagrid("getSelected").TOTAL_RECEIVED_QTY;i.datagrid("getColumnOption","QTY").editor.options.min=-1*o,e.dialog("open")}var t=$("#receiptlines"),i=$("#tracedg"),a=t.datagrid("getSelected");if(cl("row TRACE:",a.TRACE),i.datagrid("loadData",a.TRACE||[]),a.TRACE)return e();a.RECEIPT_ID=$("#RECEIPT_ID").textbox("getValue");var d=t.datagrid("getSelected");t.datagrid("getSelected").WOREF,t.datagrid("getSelected").QTY_BAL,t.datagrid("getSelected").QTY_MIN;ajaxget("/",{_func:"get",_sqlid:"inv^pol_trace",_combo:"y",PART_ID:a.PART_ID,LINE_NO:a.LINE_NO,RCVREF:a.RECEIPT_ID+"^"+a.LINE_NO},function(t){if("Y"==d._DIM_TRACKED)var n=t.lwh;else n=t.cbo;i.datagrid("getColumnOption","TRACE_ID").editor.options.data=n,a.TRACE=t.dg,i.datagrid("loadData",a.TRACE||[]),e()})},dwap.page.enable=function(e){!0===e?($("form#receipthead").removeClass("form-lock"),$("#receiptlines").datagrid("readonly",!1),$("#traced").removeClass("lock")):($("form#receipthead").addClass("form-lock"),$("#receiptlines").datagrid("readonly",!0),$("#receive_all").linkbutton("disable"),$("#traced").addClass("lock"))},dwap.page.trace=function(e,t){var i=$("#tracedg"),a=!1;if(i.datagrid("getRows").map(function(e){e.TRACE_ID==t.value&&(a=!0)}),a)return setTimeout(function(){e.combobox("clear"),msgbox("["+t.value+"] already selected.")});var d=i.datagrid("getSelected"),n=i.datagrid("getRowIndex",d),r=i.datagrid("getEditor",{index:n,field:"QTY"});if($(r.target).numberbox("set",{min:-1*t.BAL_QTY,value:-1*t.BAL_QTY,max:-1*t.BAL_QTY}),"Y"==$("#receiptlines").datagrid("getSelected")._DIM_TRACKED){[{L:"LENGTH"},{W:"WIDTH"},{H:"HEIGHT"}].map(e=>{Object.keys(e).map(a=>{var d=i.datagrid("getEditor",{index:n,field:a});$(d.target).numberbox("set",{min:t[e[a]],value:t[e[a]],max:t[e[a]]})})})}},dwap.page.opts={editor:"inline",tbarPrepend:$('<a id="receive_all" class="easyui-linkbutton" iconCls="icon-list" disabled="true">Receive All</a><span class="vert-sep" />'),striped:!0,url:"/",queryParams:{_func:"get",_sqlid:"inv^receipt_lines",_dgrid:"y",RECEIPT_ID:""},onRowContextMenu:function(e){return e.preventDefault()},loadFilter:function(e){return e&&(e.rows||0!=e.length)||(e={rows:[],total:0}),e.rows.map(function(e,t){e.LINE_NO=t+1}),e},rownumbers:!1,fitColumns:!0,fit:!0,columns:[[{field:"_INFO",hidden:!0},{field:"_UNIT_MATERIAL_COST",hidden:!0},{field:"TRACE",hidden:!0,width:300,_formatter:function(e){return jsonString(e)}},{field:"RECEIPT_ID",hidden:!0},{field:"LINE_NO",title:"#",width:25,fixed:!0},{field:"TRACEABLE",title:"TRC",width:35,fixed:!0,align:"center",formatter:function(e,t,i){return"Y"==e?'<div title="Traced" class="trace-line icon icon-trace _easyui-tooltip"></div>':"<div />"}},{field:"_DIM_TRACKED",title:"DIM",width:35,fixed:!0,align:"center",formatter:function(e,t,i){return"Y"==e?'<div title="Dim" class="dim-line icon icon-value _easyui-tooltip"></div>':"<div />"}},{field:"_L",title:"Length",width:35,fixed:!0,align:"center"},{field:"_W",title:"Width",width:35,fixed:!0,align:"center"},{field:"_H",title:"Height",width:35,fixed:!0,align:"center"},{field:"PO_LINE_NO",title:"PO Line",width:50,fixed:!0},{field:"ORDER_QTY",title:"Qty Order",width:60,fixed:!0,align:"right"},{field:"QTY_BAL",title:"Qty Bal",width:60,fixed:!0,align:"right",formatter:function(e,t,i){return`<span title="${t._INFO}" class="easyui-tooltip">${e}</span>`}},{field:"RECEIVE_QTY",title:"Qty Rcv",width:60,fixed:!0,align:"right",styler:function(e,t,i){if(e<0)return{class:"fg-red"}},editor:{type:"numberspinner",options:{precision:2,min:0,value:0,id:"rcv_qty",readonly:!1,onChange:dwap.page.notrace_onChange}}},{field:"DELIVERY_DATE",title:"Del. Date",width:80,fixed:!0,formatter:eui.date},{field:"ORDER_TYPE",title:"Order Type",width:60,formatter:function(e,t,i){return{P:"PART ORDER",S:"SUBCONTRACT",J:"JOB RELATED",E:"EXPENSE"}[e]}},{field:"LINE_STATUS",title:"Line Status",width:40},{field:"PART_ID",title:"Our Part ID",width:100},{field:"PART_DESCRIPTION",title:"Our Part Description",width:150},{field:"PURCHASE_UOM",title:"UOM",width:50,coloff:!0},{field:"WOREF",title:"Job Reference",formatter:function(e){if(e)return e.replace(/\^/g,".")}}]],onSelect:function(e,t){if(!busy($(this))){var i=$("#RECEIPT_ID").textbox("getValue"),a=$(this);"Y"==t.TRACEABLE||"Y"==t._DIM_TRACKED?(dwap.page.traceclk(),a.datagrid("getColumnOption","RECEIVE_QTY").editor.options.readonly=!0):i||(a.datagrid("getColumnOption","RECEIVE_QTY").editor.options.readonly=!1);t=a.datagrid("getSelected");a.datagrid("getColumnOption","RECEIVE_QTY").editor.options.min=t.QTY_MIN,a.datagrid("options").tbar.dgre_add.linkbutton("disable"),a.datagrid("options").tbar.dgre_del.linkbutton("disable"),a.datagrid("options").tbar.dgre_edit.linkbutton("disable")}},onBeforeLoad:function(e){if(!$("#receipthead").form("getData").RECEIPT_ID)return!1},onEndEdit:function(e,t,i){dwap.page.totals()},onLoadSuccess:function(){setTimeout(function(){dwap.page.totals()})}},dwap.page.saverows=function(e){var t=$("#PO_ID").textbox("getValue"),i=$("#receiptlines"),a=1,d=[],n=[];clone(i.datagrid("getData").rows).map(function(e,r){if(0==e.RECEIVE_QTY)d.push(r);else{e.LINE_NO=a,a++,i.datagrid("updateRow",{index:r,row:e});var o={},l={};e.TRACE&&e.TRACE.map(function(e){var t=e.TRACE_ID.split(",");e.TRACE_ID=t[0],l[e.TRACE_ID]=parseFloat(e.QTY),o[e.TRACE_ID]={L:e.L,W:e.W,H:e.H,Q:parseFloat(e.QTY)}}),n.push({PO_LINE_NO:e.PO_LINE_NO,LINE_NO:e.LINE_NO,QTY:e.RECEIVE_QTY,TRACE:l,PART_ID:e.PART_ID,WOREF:e.WOREF,PO_ID:t,ORDER_TYPE:e.ORDER_TYPE,LWH:o,_DIM_TRACKED:e._DIM_TRACKED})}}),"y"!=dwap.bhave.SAVEALL_LINES&&d.reverse().map(function(e){i.datagrid("deleteRow",e)});var r=jsonString(n);cl(r),ajaxget("/",{_sqlid:"inv^receipt_lines",_func:"add",LINE_NO:r,RECEIPT_ID:e},function(t){0==t.error&&$("#RECEIPT_ID").textbox("setValue",e)})},dwap.page.totals=function(){var e=$("#receiptlines");e.datagrid("getData").rows,frm2dic($("form#shiphead"));e.datagrid("getData").rows.map(function(e){1*e.RECEIVE_QTY})},dwap.page.isloading=function(){return $("#receiptlines").form("options").loading},$(document).ready(function(){$("#RECEIPT_ID").qbe({defid:"receipt_ids"}),$("#PO_ID").qbe({defid:"po_ids",onSelect:function(e){var t=e.value;$("#receiptlines"),$(this);""==$("#RECEIPT_ID").textbox("getValue")&&ajaxget("/",{_sqlid:"inv^pohead",_func:"get",ID:t},function(e){$("#receipthead").form("preload",e),ajaxget("/",{_sqlid:"inv^polines",_func:"get",_dgrid:"y",PO_ID:t},function(e){e.rows.map(function(e){e.PO_LINE_NO=e.LINE_NO,e.QTY_BAL=e.ORDER_QTY-e.TOTAL_RECEIVED_QTY,e.QTY_MIN=-1*e.TOTAL_RECEIVED_QTY,e.RECEIVE_QTY=0}),$("#receiptlines").datagrid("loadData",e),$("#receive_all").linkbutton("enable")})})},preload:!0}),$("#but_add").on("done",function(){dwap.page.enable(!0),$("#receiptlines").datagrid("loadData",[]);var e=$("#RECEIPT_ID");e.textbox("required",!1),e.textbox("readonly",!0),butEn("asdx")}),$("#receiptlines").datagrid("rowEditor",dwap.page.opts).datagrid("columns",$("#dgre_tb"));var e=$("#receiptlines").datagrid("options").tbar;e.dgre_add.linkbutton("disable"),e.dgre_del.linkbutton("disable"),e.dgre_edit.linkbutton("disable"),$("#receive_all").linkbutton({onClick:function(){$(this).linkbutton("disable");var e=$("#receiptlines");e.datagrid("getData").rows.map(function(t,i){"Y"==t.TRACEABLE?msgbox("Line "+t.LINE_NO+" is traceable."):"Y"==t._DIM_TRACKED?msgbox("Line "+t.LINE_NO+" is dimensions tracked."):(t.RECEIVE_QTY=t.QTY_BAL,e.datagrid("updateRow",{index:i,row:t}))})}}),$("#tracedg").datagrid().datagrid("rowEditor",{fit:!0,fitColumns:!0,editor:"inline",striped:!0,addData:{QTY:0,L:0,W:0,H:0},onEndEdit:function(e,t,i){var a=$(this).datagrid("getRows"),d=$("#receiptlines"),n=d.datagrid("getSelected"),r=(e=d.datagrid("getRowIndex",n),0);a.map(function(e){r+=parseFloat(e.QTY)}),d.datagrid("updateRow",{index:e,row:{TRACE:a,RECEIVE_QTY:r}})},onCancelEdit:function(e,t){t.editing=!1,$(this).datagrid("refreshRow",e)},columns:[[{field:"TRACE_ID",title:"Trace ID",width:100,editor:{type:"combobox",options:{required:!0,onSelect:function(e){var t=$(this);dwap.page.trace(t,e)}}}},{field:"QTY",title:"Qty Rcv",width:70,fixed:!0,editor:{type:"numberspinner",options:{precision:2,min:0,value:0,readonly:!1,onChange:dwap.page.trace_onChange}}},{field:"L",title:"Length",width:70,fixed:!0,editor:{type:"numberspinner",options:{precision:2,min:0,readonly:!1}}},{field:"W",title:"Width",width:70,fixed:!0,editor:{type:"numberspinner",options:{precision:2,min:0,readonly:!1}}},{field:"H",title:"Height",width:70,fixed:!0,editor:{type:"numberspinner",options:{precision:2,min:0,readonly:!1}}}]]}),$("div#traced").dialog({iconCls:"icon-trace",onClose:function(){$("#tracedg").datagrid("editButs",{ok:"click"}),$("#receiptlines").datagrid("editButs",{ok:"click"})}}),$("form#receipthead").on("loadDone",function(e,t){dwap.page.enable(!1),$("#receiptlines").datagrid("load",{_func:"get",_sqlid:"inv^receipt_lines",_dgrid:"y",RECEIPT_ID:t.RECEIPT_ID})}).on("success",function(e,t){t.res._next&&dwap.page.saverows(t.res._next)})});