dwap.page.dgedit=function(e){$("#but_dg_edit, #but_dg_del").linkbutton(e)},dwap.page.clicks=function(e){var d=$(e.target).closest("a").linkbutton("options").text,t=$("#cpdg"),a=$("#dgedit"),i=t.datagrid("getSelected"),o=t.datagrid("getRowIndex",i),l=$("form#dgform"),n=frm2dic($("form#head"));switch(d){case"Add":var c=t.datagrid("getRows");if(c.length)s=parseInt(c.slice(-1)[0].LINE_NO)+1;else var s=1;$("form#dgform input#LINE_NO").numberbox("setValue",s),l.attr("mode","add"),a.dialog("open");break;case"Delete":if(nodclick($(this)),-1==o)return;confirm(function(e){e&&ajaxget("/",{_sqlid:"inv^cprop_item",_func:"del",CP_ID:i.CP_ID,LINE_NO:i.LINE_NO},function(e){if(e.error)return!1;t.datagrid("deleteRow",o),dwap.page.dgedit("disable"),grnflash("#but_save")})},"Delete selected row ?");break;case"Edit":a.dialog("open"),l.form("load",i).attr("mode","upd");break;case"Save":nodclick($(this));var f=frm2dic(l);if(!l.form("validate"))return!1;f._sqlid="inv^cprop_item",f._func=l.attr("mode"),f.CP_ID=n.CP_ID,ajaxget("/",f,function(e){if(e.error)return!1;"upd"==f._func?t.datagrid("updateRow",{index:o,row:f}):t.datagrid("appendRow",f),a.dialog("close"),grnflash("#but_save")});break;case"Close":dwap.page.dgedit("disable"),a.dialog("close"),l.form("reset")}},dwap.page.headChange=function(e,d,t){butEn("axsd");var a=e.attr("textboxname");frm2dic($("form#head"))},dwap.page.dgload=function(e){$("#cpdg").datagrid("load",{CP_ID:e.CP_ID,_func:"get",_sqlid:"inv^cprop_item",_dgrid:"y"})},dwap.page.jobmode=function(e){var d=$("#jobadd"),t=$("#jobclone"),a=$("#BASE_ID");switch(d.hide(),t.hide(),a.combobox("readonly",!0),e.value){case"SELECT":a.combobox("readonly",!1);break;case"CLONE":t.show();case"BLANK":d.show()}},$(document).ready(function(){for(var e in $("#CP_ID").combobox("filtertip",{default:["IN-HOUSE"],field:"STATUS",data:[{name:"IN-HOUSE",text:"IN-HOUSE"},{name:"RETURNED",text:"RETURNED"}]}),$("#but_add").on("done",function(){$("#cpdg").datagrid("loadData",{total:0,rows:[]}),$("#STATUS").combobox("select","I"),$("#CUST_ID").textbox("readonly",!1),butEn("dx")}),dwap.page.udfs={},dwap.pdata.udfid&&dwap.pdata.udfid.map(function(e){e.value==dwap.bhave.UDF_LAYOUT_ID&&(dwap.page.udfs=e)}),dwap.page.cols=[{field:"CP_ID",hidden:!0},{field:"LINE_NO",title:"#",width:25,fixed:!0},{field:"SALES_ORDER_ID",title:"Sales Order Ref",width:100,fixed:!0},{field:"PERMIT",title:"Permit",width:100,fixed:!0},{field:"CUST_PO",title:"Cust PO",width:100,fixed:!0},{field:"CUST_PART_ID",title:"Cust Part #",width:100,fixed:!0},{field:"PART_ID",title:"Our Part #",width:100,fixed:!0},{field:"LOCN",title:"Location",width:100,fixed:!0},{field:"NCR_ID",title:"NCR Ref",width:80,fixed:!0},{field:"QTY_RECV",title:"Qty",width:35,fixed:!0},{field:"ACTION",title:"Action",width:100,fixed:!0},{field:"BASE_ID",title:"Job ID",width:80,fixed:!0},{field:"COC_ID",title:"COC IDs",width:80,fixed:!0,hidden:!0},{field:"DATE_RETURN",title:"Return Date",formatter:tz2date,width:80,fixed:!0,hidden:!0}],dwap.page.udfs){var d=dwap.page.udfs[e];0===e.indexOf("UDF_")&&""!==d&&dwap.page.cols.push({field:e.replace("UDF_","USER_"),title:d,width:80,hidden:!0})}dwap.page.cols.push({field:"DESCRIPTION",title:"Description",width:200}),setTimeout(function(){$("#dgedit").dialog({iconCls:"icon-edit",title:"Edit Item",modal:!0,closed:!0,width:"780px",buttons:[{iconCls:"icon-save",text:"Save",handler:dwap.page.clicks},{iconCls:"icon-cancel",text:"Close",handler:dwap.page.clicks}],onOpen:function(){var e=$("form#dgform");dwap.page.udfok||(setudfs(dwap.page.udfs,e),$(this).dialog("resize"),dwap.page.udfok=!0)},onClose:function(){setTimeout(function(){$("#cpdg").datagrid("unselectAll")},250),dwap.page.dgedit("disable")}}),$.each($("form#head input.textbox-f").not(".fkey"),function(){var e=$(this),d=e.attr("class").split(" ")[0].split("-")[1];e[d]({onChange:function(d,t){dwap.page.headChange(e,d,t)}})})}),$("form#dgform").on("success",function(e,d){frm2dic($(this))}).on("loadDone",function(e,d){$(this).form("reselect")}),$("form#head").on("success",function(e,d){var t=frm2dic($(this));butEn("axd"),$("#but_dg_add").linkbutton("enable"),dwap.page.dgload(t)}).on("loadDone",function(e,d){butEn("axd"),$("#SALES_ORDER_ID").combobox("reload","/?_func=get&_sqlid=sales^sorefs&_combo=y&CUST_ID="+d.CUST_ID),$("#cpfiles").datagrid("docFiles",d.CP_ID),$("#but_dg_add").linkbutton("enable"),dwap.page.dgload(d),$(this).form("reselect")}),$("#DOJOB").combobox({panelHeight:"auto",editable:!1,data:[{value:"SELECT",text:"Select Job"},{value:"CLONE",text:"New Clone Job"},{value:"BLANK",text:"New Blank Job"}],onSelect:dwap.page.jobmode}),$("#PART_ID").qbe({defid:"part"}),$("#CUST_ID").combobox({url:"/?_func=get&_sqlid=sales^custall&_combo=y",onSelect:function(e){$("#CUST_NAME").textbox("setValue",e.NAME),$("#SALES_ORDER_ID").combobox("reload","/?_func=get&_sqlid=sales^sorefs&_combo=y&CUST_ID="+e.value)}}),$("#SALES_ORDER_ID").combobox({groupField:"CUST_ID",onSelect:function(e){var d=$("#CP_ID").combobox("getValue"),t=$("#cpdg").datagrid("getSelected");$("#CUST_PART_ID").textbox("setValue",e.CUST_PART_ID),ajaxget("/",{_sqlid:"inv^cprop_items",_func:"get",SALES_ORDER_ID:e.value},function(a){a.map(function(a){if(d+"^"+t.LINE_NO!=a.CP_ID+"^"+a.LINE_NO)return msgbox("The Sales Order Ref ,"+e.text+", linked to other CP Line,"+a.CP_ID+"^"+a.LINE_NO+"."),$("#SALES_ORDER_ID").combobox("setValue",""),!1})})}}),$("#BASE_ID").qbe({defid:"job",onSelect:function(e){if(e){var d=[];dwap.pdata.bascoc.COC_ID&&(dwap.pdata.bascoc=[dwap.pdata.bascoc]),dwap.pdata.bascoc.map(function(t){t.WOREF==e.value&&d.push(t.COC_ID)}),$("#COC_ID").textbox("setValue",d.join(","))}}}),$("#ACTION").combobox({panelHeight:"auto",editable:!1,data:JSON.parse(dwap.bhave.ACTION),onSelect:function(e){"_NONE_"==e.source?$("#jobdiv").hide():$("#jobdiv").show()}}),$("#cpdg").datagrid({striped:!0,singleSelect:!0,method:"get",url:"/",fit:!0,fitColumns:!0,columns:[dwap.page.cols],toolbar:[{id:"but_dg_add",text:"Add",iconCls:"icon-add",disabled:!0,handler:dwap.page.clicks},{id:"but_dg_edit",text:"Edit",iconCls:"icon-edit",disabled:!0,handler:dwap.page.clicks},{id:"but_dg_del",text:"Delete",iconCls:"icon-delete",disabled:!0,handler:dwap.page.clicks}],onLoadSuccess:function(){$(this).datagrid("fitColumns")},onSelect:function(){dwap.page.dgedit("enable")},onDblClickRow:function(e,d){$("a#but_dg_edit").click()}})});