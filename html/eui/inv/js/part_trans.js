dwap.page.arrFilter=function(e,a,t){var o=[];return e.map(function(e){e[a]==t&&o.push(e)}),o},dwap.page.dimvis=function(e){$.each($(".dimin"),function(){var a=$(this),t=a.attr("id").replace("DIM_",""),o=!0,n="show";"Y"!=e[t]&&(o=!1,n="hide"),a.numberbox("required",o),$("#_"+t)[n]()})},dwap.page.dimcalc=function(){var e=1,a=$("#QTY");if($.each($(".dimin"),function(){var a=$(this);e*=a.numberbox("getValue")||1}),e*=$("#DIM_PC_QTY").numberspinner("getValue"),a.numberbox("setValue",e),"JOB-IN"==dwap.page.stat){var t=$("#DIM_LWH").combobox("getRec"),o=(t.HEIGHT||1)*(t.LENGTH||1)*(t.WIDTH||1)*t.PC_QTY;a.numberbox("getValue")>o&&(msgbox("Returned exceeds issued qty."),a.numberbox("setValue",0))}},dwap.page.lwhselect=function(){var e=$(this).attr("id"),a=1,t=$("#DIM_PC_QTY"),o=$("#DIM_LWH").combobox("getRec");$.each($(".dimin"),function(){var e=$(this).attr("id").replace("DIM_","");$(this).numberbox("setValue",o[e])}),$("#DIM_PC_AVAIL").numberbox("setValue",o.PC_QTY),t.numberspinner("set",{min:1,max:o.PC_QTY}),"DIM_LWH"==e&&t.numberspinner("setValue",o.PC_QTY);var n=t.numberspinner("getValue");a*=(o.HEIGHT||1)*(o.LENGTH||1)*(o.WIDTH||1)*n,$("#QTY").numberbox("setValue",a)},dwap.page.dimdiv=function(e){var a=e.part,t=$("#QTY"),o=$("#dimsdiv"),n=$("#dimout"),r=$("#dimin"),i=$("#DIM_PC_QTY"),d=$("#DIM_LWH");"Y"==a.DIM_TRACKED?(t.numberspinner("readonly",!0),o.show(),dwap.page.dimvis(a),$(".dimin").numberbox({onChange:dwap.page.dimcalc}).next("span.textbox").addClass("textbox-readonly"),i.numberspinner({onChange:dwap.page.dimcalc}),"ADJ-IN"==dwap.page.stat?(n.hide(),r.show(),$(".dimin").numberbox({editable:!0}).next("span.textbox").removeClass("textbox-readonly"),d.combobox({required:!1})):(n.show(),d.combobox({required:!0,_init:null,_traceid:null,_woref:null,onSelect:dwap.page.lwhselect,data:e.dims,loadFilter:function(e){var t=["LENGTH","WIDTH","HEIGHT"],o=$(this).combobox("options");return o._traceid||o._woref?(o._traceid&&(fdata=dwap.page.arrFilter(e,"TRACE_ID",o._traceid)),o._woref&&(fdata=dwap.page.arrFilter(fdata,"WOREF",o._woref)),o._woref=null,o._traceid=null,multisort(fdata,t)):(e.map(function(e){var o=[];t.map(function(t){"Y"==a[t]&&o.push(t[0]+":"+e[t])}),e.text=o.join(" x ")}),multisort(e,t))}}).combobox("readonly",!1).removeAttr("readonly"))):(t.numberspinner("readonly",!1),o.hide())},dwap.page.jobcost=function(){if("FG-IN"==dwap.page.stat){var e=$("#TRACE_MATERIAL_COST"),a=$("#QTY").numberspinner("getValue"),t=$("#JOB_COST").textbox("getValue");a>0&&e.numberspinner("setValue",t/a)}},dwap.page.tracediv=function(e){var a=$("#tracediv"),t=$("#TRACE_ID");"Y"==e.TRACEABLE?(a.show(),t.combobox("required")):(a.hide(),t.combobox("required",!1))},dwap.page.traceadd=function(e){var a=$("#TRACE_ID"),t=$("#EXPIRY_DATE"),o=$("#tracebal");e?(a.combobox("toText"),t.datebox("readonly",!1).removeAttr("readonly"),o.hide()):(a.combobox("toCombo"),o.show(),t.datebox("readonly",!0))},dwap.page.switch=function(){var e=$("#PART_ID"),a=e.combobox("options"),t=$("#WOREF"),o=t.combobox("options"),n=$("#TRACE_ID"),r=(n.combobox("options"),$("#TRACE_MATERIAL_COST"));function i(e){var a=$("#jobdiv");e?(a.show(),t.textbox("required",!0)):(a.hide(),t.textbox("required",!1))}function d(e,a,t){if("string"==typeof e&&(e=[e]),!t)return[];var o=[];return t.map(function(t){e.indexOf(t.PART_CLASS_ID)>-1&&(a&&t.BAL_QTY>0?o.push(t):a||o.push(t))}),o}function p(e,a){if("Y"==e.part.TRACEABLE){var t=e.part.LOT_SIZE;dwap.page.props(e),n.combobox("loadData",a),r.numberbox("setValue",a.TRACE_MATERIAL_COST),r.numberbox("readonly",!0)}else t=e.part.BAL_QTY;dwap.page.minmax(1,t)}switch(dwap.page.part={data:[],bals:[]},dwap.page.jobopt={data:[]},dwap.page.traceopt={data:[]},dwap.page.stat){case"ADJ-IN":dwap.page.part.onLoad=function(e){if(dwap.page.dimdiv(e),"Y"==e.part.TRACEABLE){if(dwap.page.traceadd(!0),dwap.page.tracediv(e.part),n.combobox("loadData",e.trace),dwap.page.props(e),"Y"==e.part.TRACEABLE)var a=e.part.LOT_SIZE}else dwap.page.tracediv(e.part),dwap.page.traceadd(!1);dwap.page.minmax(1,a)},dwap.page.traceopt.onSelect=function(e){var a=e.LOT_SIZE-e.BAL_QTY;$("#BAL_QTY").numberbox("setValue",a),dwap.page.minmax(1,a),$("#TRACE_MATERIAL_COST").numberbox("readonly",!1)},e.combobox("loadData",d(["COMP","FG","CONSUMABLE"],!1,a.allRows));break;case"ADJ-OUT":dwap.page.part.onLoad=function(e){dwap.page.tracediv(e.part),dwap.page.dimdiv(e),p(e,e.trace)},e.combobox("loadData",d(["COMP","FG","CONSUMABLE"],!0,a.allRows));break;case"JOB-OUT":dwap.page.shift&&$(".textbox-icon.icon-search").click(),dwap.page.part.onLoad=function(e){dwap.page.dimdiv(e),p(e,e.trace),i(!0),dwap.page.tracediv(e.part),t.combobox("loadData",e.jobs)},e.combobox("loadData",d(["COMP","FG","CONSUMABLE"],!0,a.allRows));break;case"JOB-IN":var l;dwap.page.shift&&$(".textbox-icon.icon-search").click(),dwap.page.part.onLoad=function(e){l=e,dwap.page.dimdiv(l);var a=[];l.jobs.map(function(e){a.push({text:woref2text(e.WOREF),value:e.WOREF})}),t.combobox("loadData",function(e,a){a=a||"value";var t=[],o=[];return e.map(function(e){-1==o.indexOf(e[a])&&(o.push(e[a]),t.push(e))}),t}(a)),i(!0)},e.combobox("loadData",d(["COMP","FG","COMSUMABLE"],!1,a.allRows)),dwap.page.jobopt.onSelect=function(e){dwap.page.tracediv(l.part);var a=dwap.page.arrFilter(l.jobs,"WOREF",e.value);p(l,a),dwap.page.minmax(1,a[0].BAL_QTY)};break;case"FG-IN":dwap.page.part.onLoad=function(e){var a=t.combobox("getRec"),o=dwap.bhave.FG_MAXRECV||100,i=a.RECEIVED_QTY||0,d=parseInt(o)/100*a.qreq-i;if("Y"==e.part.TRACEABLE){if(dwap.page.props(e),dwap.page.traceadd(!0),dwap.page.tracediv(e.part),n.combobox("loadData",e.trace),e.part.LOT_SIZE>d)var p=d;else p=e.part.LOT_SIZE;"y"==dwap.bhave.FG_IN_DEF_JOB_AS_TRACE&&n.combobox("setValue",$("#BASE_ID").textbox("getValue")),"P"==dwap.bhave.FG_IN_UNIT_TRACE_COST&&r.numberspinner("setValue",$("#UNIT_MATERIAL_COST").numberspinner("getValue"))}else p=d;dwap.page.tracediv(e.part),dwap.page.minmax(1,p)},dwap.page.jobopt.onSelect=function(a){e.combobox("select",a.PART_ID)};var b=[];o.basRows.map(function(e){"FG"==e.WO_TYPE&&b.push(e)}),t.combobox("loadData",b),i(!0),e.combobox("loadData",d("FG",!1,a.allRows)),e.combobox("readonly",!0);break;case"FG-OUT":dwap.page.part.onLoad=function(e){i(!0);var a=[];o.basRows.map(function(t){"FG"==t.WO_TYPE&&t.PART_ID==e.part.ID&&a.push(t)}),t.combobox("loadData",a),dwap.page.tracediv(e.part),p(e,e.trace)},e.combobox("loadData",d("FG",!0,a.allRows));break;case"SHP-OUT":dwap.page.part.onLoad=function(e){dwap.page.tracediv(e.part),p(e,e.trace)},dwap.page.traceadd(!1),t.combobox("loadData",[]),e.combobox("loadData",d(["COMP","FG"],!0,a.allRows));break;case"SHP-IN":dwap.page.part.onLoad=function(e){dwap.page.tracediv(e.part),p(e,e.ship)};var s=[];b=[];a.shipRows.map(function(e){-1==s.indexOf(e.value)&&(s.push(e.value),b.push(e))}),e.combobox("loadData",b)}},dwap.page.fdat=function(e){var a=frm2dic($("form#trans"));return e?a[e]||null:a},dwap.page.minmax=function(e,a){if(a=a||1e6,e=e||1,1e6==a);else;$("#AVAIL_BAL").numberbox("setValue",parseFloat(a).toFixed(2)),$("#QTY").numberspinner("set",{val:0,min:0,max:1*a})},dwap.page.minmax_CLS=function(e,a){if(a<=0)var t=0;else t=a;if(e=e||1,1e6==t);else;$("#AVAIL_BAL").numberbox("setValue",parseFloat(t).toFixed(2)),$("#QTY").numberspinner("set",{val:0,min:0,max:1*t})},dwap.page.props=function(e){for(var a in e.part)if(0==a.indexOf("TRACE_USER_")){var t=$("div#traceprop div.fitem#"+a),o=t.find("label.trace"),n=t.find("input.textbox-f");""!=e.part[a]?(o.text(e.part[a].replace("*","")),t.show(),"ADJ-IN"==dwap.page.stat&&0===e.part[a].indexOf("*")&&n.textbox("required")):t.hide()}},dwap.page.lock=function(e){e?$("form#trans").removeClass("lock"):$("form#trans").addClass("lock");var a=$("#TRANSACTION_DATE");"y"==(dwap.bhave.ALLOWED_EDIT_TXDATE||"n")?a.datebox("readonly",!1).removeAttr("readonly"):a.datebox("readonly",!0).removeAttr("readonly")},dwap.page.part_locked=function(){var e=$("#LOCKED").textbox("getValue"),a=$("#PART_ID").combobox("getValue");"Y"==e?(msgbox("Part "+a+" LOCKED. <br><b>Part Trans NOT allowed!</b>"),$("#SAVE").linkbutton("disable")):$("#SAVE").linkbutton("enable")},$(document).keydown(function(e){81==e.keyCode&&(dwap.page.shift=!0)}).keyup(function(e){81==e.keyCode&&(dwap.page.shift=!1)}),$(document).ready(function(){$("#DIM_LENGTH, #DIM_WIDTH, #DIM_HEIGHT").numberbox({editable:!1,icons:[{enabled:!0,iconCls:"icon-edit",handler:function(e){if(e.preventDefault(),/JOB-IN|ADJ-IN/.test(dwap.page.stat)){$("#DIM_LWH").combobox("readonly",!0),$("#DIM_PC_QTY").numberspinner("set",{max:null});var a=$(e.data.target);setTimeout(function(){a.textbox({editable:!0}),a.next("span.textbox").removeClass("textbox-readonly"),euifocus(a)})}}}]}),$("#JOB_QBE").qbe({queryParams:{_sqlid:"vwltsa^seqpart_qbe"},onDemand:!0,valueField:"PART_ID",fit:!0,fitColumns:!0,fields:[{field:"WOREF",title:"Job ID",editor:"textbox",formatter:function(e){return e.split("^")[0]}},{field:"SEQ_NO",title:"Seq No",formatter:function(e,a,t){return a.WOREF.split("^").slice(-1)[0]}},{field:"PART_ID",title:"Part ID",editor:"textbox"},{field:"DESCRIPTION",title:"Description",editor:"textbox"},{field:"REQUIRED_QTY",title:"Qty Reqd"},{field:"QTY_DUE_FROM_",title:"Qty Due",editor:"numberbox"},{field:"REQUIRED_QTY_FROM_",title:"Min Qty Reqd",editor:"numberbox",hidden:!0},{field:"ISSUED_QTY_FROM_",title:"Min Qty Due",editor:"numberbox",hidden:!0}],fields:[{field:"WOREF",title:"Job ID",editor:"textbox",formatter:function(e){return e.split("^")[0]}},{field:"SEQ_NO",title:"Seq No",formatter:function(e,a,t){return a.WOREF.split("^").slice(-1)[0]},editor:"textbox"},{field:"PART_ID",title:"Part ID",editor:"textbox"},{field:"WANT_DATE_FROM_",title:"Min Due Date",editor:"datebox",hidden:!0},{field:"WANT_DATE",title:"Due Date",formatter:eui.date},{field:"REQUIRED_QTY_FROM_",title:"Min Qty Reqd",editor:{type:"numberbox",options:{value:1}},hidden:!0},{field:"REQUIRED_QTY",title:"Qty Reqd"},{field:"QTY_DUE_FROM_",title:"Min Qty Due",editor:{type:"numberbox",options:{value:1}},hidden:!0},{field:"QTY_DUE",title:"Qty Due"},{field:"DESCRIPTION",title:"Description",editor:"textbox"}],onSelect:function(e){$("#WOREF").combobox("options")._qbeworef=e.WOREF,$("#PART_ID").combobox("select",e.PART_ID)}}),$("#LOT_SIZE").numberbox(),$("#PART_ID").combobox({qbeworef:null,rec:{},loadFilter:function(e){var a=$(this).combobox("options");return a.allRows?multisort(e,["PART_CLASS_ID","value"]):(a.allRows=e.part,a.traceRows=e.trace,a.jobRows=e.jobs,a.shipRows=e.ship,$("#modediv a").linkbutton("enable"),[])},onSelect:function(e){var a=$(this).combobox("options");e||msgbox("This is not a stockable part"),ajaxget("/",{_sqlid:"inv^tracepart",_func:"get",ID:e.value,TRANS_TYPE:dwap.page.stat,MISC_TRANS:dwap.bhave.ALLOWED_MISC_TX||"n"},function(e){if(e.error)return reload();a.rec=e,$("#PART_DESC").textbox("setValue",a.rec.part.DESCRIPTION),$("#PART_UOM").textbox("setValue",a.rec.part.UOM_ID),$("#TRACEABLE").textbox("setValue",{Y:"Traceable",N:"Not Traceable"}[a.rec.part.TRACEABLE]||"Not Traceable"),$("#LOCKED").textbox("setValue",a.rec.part.LOCKED),$("#DIM_TRACKED").textbox("setValue",a.rec.part.DIM_TRACKED).textbox("setText",{Y:"Yes",N:"No"}[a.rec.part.DIM_TRACKED]||"No"),$("#DIM_UOM").textbox("setValue",a.rec.part.DIM_UOM),$("#LOT_SIZE").numberbox("setValue",a.rec.part.LOT_SIZE);var t=$("#UNIT_MATERIAL_COST");for(var o in t.numberbox("setValue",a.rec.part.UNIT_MATERIAL_COST),t.numberbox("readonly",!0),$("#SAVE").linkbutton("enable"),setudfs(e.udf,$("form#trans")),a.rec.part)0==o.indexOf("USER_")&&$('input[textboxname="'+o+'"]').textbox("setValue",a.rec.part[o]);$("#udfs").show(),dwap.page.part.onLoad(e),dwap.page.part_locked()})}}),$("#WOREF").combobox({_qbeworef:null,groupField:"BASE_ID",loadFilter:function(e){var a=$(this).combobox("options");return a.basRows?e:(e.bas.map(function(e){e.value+="^0"}),a.basRows=e.bas,a.seqRows=e.seq,{bas:[],seq:[]})},onLoadSuccess:function(e){var a=$(this),t=a.combobox("options");t._qbeworef&&setTimeout(function(){objidx(e,"value",t._qbeworef)<0?msgbox(t._qbeworef+" job is not selectable."):a.combobox("select",t._qbeworef),t._qbeworef=null},200)},onSelect:function(e){"n"==dwap.bhave.WIP_COUNT_ALLOW_JOB_OUT&&ajaxget("/",{_sqlid:"inv^wip_count_job",_func:"get",WOREF:e.value},function(a){a.length>0?(msgbox("**<b>Job, "+e.value+" in ACTIVE WIP COUNT ,"+a[0].WIP_COUNT_ID+" **</b>\n Material issue not allowed!"),$("#SAVE").linkbutton("disable")):$("#SAVE").linkbutton("enable")});var a=e.value.split("^");$("#BASE_ID").textbox("setValue",a[0]);var t=e.qreq+" / "+e.RECEIVED_QTY;if($("#QTY_REQ").textbox("setValue",t),$("#JOB_COST").textbox("setValue",e.ACT_TOTAL_COST),$("input#QTY_RCVD").val(e.RECEIVED_QTY),a.length>1&&($("#SUB_ID").textbox("setValue",a[1]),$("#SEQ_ID").textbox("setValue",a[2])),dwap.page.jobopt.onSelect)return dwap.page.jobopt.onSelect(e);var o=$("#PART_ID").combobox("options").rec.part;dwap.page.tracediv(o)}}),$("#TRACE_ID").combobox({editable:!1,loadFilter:function(e){var a=$(this).combobox("options");return a.allRows||(a.allRows=e),e},formatter:function(e){return e.value+" ( "+e.BAL_QTY+" )"},onSelect:function(e){if(["ADJ-IN","FG-IN"].indexOf(dwap.page.stat)>-1&&"Y"==dwap.page.fdat("DIM_TRACKED"))return!1;if(dwap.page.traceopt.onSelect)return dwap.page.traceopt.onSelect(e);if($("#BAL_QTY").numberbox("setValue",e.BAL_QTY),$("#EXPIRY_DATE").datebox("setValue",e.EXPIRY_DATE),dwap.page.minmax(1,e.BAL_QTY),"Y"==dwap.page.fdat("DIM_TRACKED")){var a=$("#DIM_LWH");$("#dimin .textbox-f, #dimout .textbox-f").textbox("clear"),a.combobox("options")._traceid=e.TRACE_ID,a.combobox("options")._woref=e.WOREF,a.combobox("reload")}function t(){var a=$("#TRACE_MATERIAL_COST");a.numberbox("setValue",e.TRACE_MATERIAL_COST),a.numberbox("readonly",!0);var t={};for(var o in e)0==o.indexOf("TRACE_USER_")&&(t[o]=e[o]);$("form#trans").form("load",t)}if(e.EXPIRY_DATE&&new Date(e.EXPIRY_DATE)<new Date){if("JOB-OUT"==dwap.page.stat&&"y"!=dwap.bhave.EXPIRED_ALLOW_JOB_OUT)return msgbox("Cannot issue expired material to Job"),$("#tracediv .textbox-f").textbox("reset");confirm(function(e){e?t():$("#tracediv .textbox-f").textbox("reset")},"Trace has expired. Continue ?")}else t()},delay:500,onChange:function(e,a){-1!=["ADJ-IN","FG-IN"].indexOf(dwap.page.stat)&&"Y"!=dwap.page.fdat("DIM_TRACKED")&&(e&&$(this).combobox("find",{value:e})&&msgbox("Warning, Trace ID "+e+" exists for this part."),$("#traceprop input.textbox-f").textbox("readonly",!1))}}),$("#typediv > a").linkbutton({disabled:!1,iconAlign:"left",onClick:function(e){var a=$(this).attr("name");dwap.page.typediv=a,putcook("vwltsa^matl^part_trans",a);var t=$("#compdiv"),o=$("#fgdiv");"FG"==a?(t.hide(),o.show()):(t.show(),o.hide())}});var e=getcook("vwltsa^matl^part_trans");e&&$("a[name="+e+"]").click(),$("#modediv a").linkbutton({disabled:!0,size:"large",iconAlign:"top",onClick:function(e){$("#typediv").addClass("lock");var a=$(this);dwap.page.stat=a.attr("name"),$("#TRANS_TYPE").val(dwap.page.stat),$("#modediv a").not($(this)).linkbutton("disable").linkbutton("unselect"),dwap.page.lock(!0),dwap.page.switch()}}),$("#SAVE").linkbutton({disabled:!0,size:"large",iconAlign:"top",onClick:function(){var e=$(this);if(nodclick(e,2e3),dwap.page.fdat("QTY")<0)return msgbox("Quantity must be greater than 0.");var a=$("form#trans");a.form("options").queryParams._mode=dwap.page.mode,a.form("submit")}}),$("#CANCEL").linkbutton({disabled:!1,size:"large",iconAlign:"top",onClick:function(){reload()}}),$("form#trans").form({url:"/",queryParams:{_sqlid:"inv^invtrans",_func:"add"},success:function(e){if((e=JSON.parse(e)).error)return msgbox(e.msg);grnflash("#but_save"),setTimeout(function(){reload()},500)}}),$("#QTY").numberspinner({onChange:function(e,a){if("FG-IN"==dwap.page.stat&&"J"==dwap.bhave.FG_IN_UNIT_TRACE_COST){var t=$("#TRACE_MATERIAL_COST");t.numberspinner("setValue",0);var o=$("#JOB_COST").textbox("getValue"),n=$("input#QTY_RCVD").val(),r=1*e+parseFloat(n);r>0&&t.numberspinner("setValue",o/r)}}})});